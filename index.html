<!doctype html>
<html>
    
    <head>
        <title>Solving Subtraction Problems</title>
        <!-- Load jQuery -->
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script src="scripts/raphael.js"></script>
        <!-- Load the jspsych library and plugins -->
        <script src="scripts/jspsych.js"></script>
        <script src="scripts/plugins/jspsych-text.js"></script>
        <script src="scripts/plugins/jspsych-single-stim.js"></script>
        <script src="scripts/plugins/subtractionStimPlugin.js"></script>
	<script src="scripts/underscore_min.js"></script>
	<script src="scripts/plugins/jspsych-twostim-tworesponse.js"></script>
	<script src="scripts/plugins/fixation_cross.js"></script>
        <!-- Load the stylesheet -->
        <link href="experiment.css" type="text/css" rel="stylesheet"></link>
    </head>
    
    <body>
        <div id="jspsych_target"></div>
    </body>
    
    <script type="text/javascript">

		/* Define all possible trials */
		var numMatrix3 = [
			['7','3','4','2','2','1','3'],
			['9','4','5','3','2','2','3'],
			['10','3','7','6','1','2','3'],
			['12','6','6','3','3','3','3'],
			['8','3','5','3','2','1','3'],
			['5','3','2','1','1','2','3'],
			['8','3','5','4','1','2','3'],
			['9','3','6','5','1','2','3'],
			['11','6','5','3','2','4','3'],
			['6','3','3','2','1','2','3']
				];
		var numMatrix4 = [
			['10','4','6','5','1','3','4'],
			['11','4','7','6','1','3','4'],
			['9','4','5','2','3','1','4'],
			['12','4','8','5','3','1','4'],
			['13','4','9','6','3','1','4'],
			['8','3','5','4','1','2','4'],
			['9','3','6','4','2','1','4'],
			['11','5','6','4','2','3','4'],
			['12','5','7','4','3','2','4'],
			['15','6','9','4','5','1','4'],
			['10','2','6','2','1','3','4'],
			['11','5','7','5','1','3','4'],
			['11','2','7','2','1','3','4'],
			['9','6','5','6','3','1','4'],
			['12','2','8','2','3','1','4'],
			['12','6','8','6','3','1','4'],
			['13','2','9','2','3','1','4'],
			['13','5','9','5','3','1','4']];
			
			numMatrix5= [
			['11','5','6','4','2','3','5'],
			['13','5','8','6','2','3','5'],
			['14','5','9','7','2','3','5'],
			['12','5','7','4','3','2','5'],
			['14','5','9','6','3','2','5'],
			['15','5','10','7','3','2','5'],
			['12','5','7','3','4','1','5'],
			['15','5','10','6','4','1','5'],
			['16','5','11','7','4','1','5'],
			['9','3','6','5','1','2','5'],
			['10','4','6','5','1','3','5'],
			['10','3','7','5','2','1','5'],
			['13','6','7','5','2','4','5'],
			['12','4','8','5','3','1','5'],
			['15','7','8','5','3','4','5'],
			['15','6','9','5','4','2','5'],
			['16','7','9','5','4','3','5'],
			['18','7','11','5','6','1','5'],
			['11','7','6','7','2','3','5'],
			['13','4','8','4','2','3','5'],
			['13','7','8','7','2','3','5'],
			['14','4','9','4','2','3','5'],
			['14','6','9','6','2','3','5'],
			['12','6','7','6','3','2','5'],
			['14','4','9','4','3','2','5'],
			['14','7','9','7','3','2','5'],
			['15','4','10','4','3','2','5'],
			['15','6','10','6','3','2','5'],
			['12','6','7','6','4','1','5'],
			['15','3','10','3','4','1','5'],
			['15','3','10','3','4','1','5'],
			['15','7','10','7','4','1','5'],
			['16','3','11','3','4','1','5'],
			['16','6','11','6','4','1','5'],
			['9','4','6','4','1','2','5'],
			['9','7','6','7','1','2','5'],
			['10','7','6','7','1','3','5'],
			['10','4','7','4','2','1','5'],
			['10','6','7','6','2','1','5'],
			['13','3','7','3','2','1','5'],
			['12','6','8','6','3','1','5'],
			['12','7','8','7','3','1','5'],
			['15','6','8','6','3','4','5'],
			['15','3','9','3','4','2','5'],
			['15','7','9','7','4','2','5'],
			['16','6','9','6','4','3','5'],
			['18','4','11','4','6','1','5']];
			numMatrix6 = [
			['14','6','8','7','1','5','6'],
			['15','6','9','8','1','5','6'],
			['13','6','7','5','2','4','6'],
			['15','6','9','7','2','4','6'],
			['16','6','10','8','2','4','6'],
			['15','6','9','5','4','2','6'],
			['17','6','11','7','4','2','6'],
			['18','6','12','8','4','2','6'],
			['15','6','9','4','5','1','6'],
			['18','6','12','7','5','1','6'],
			['19','6','13','8','5','1','6'],
			['11','4','7','6','1','3','6'],
			['12','5','7','6','1','4','6'],
			['13','5','8','6','2','3','6'],
			['15','7','8','6','2','5','6'],
			['13','4','9','6','3','1','6'],
			['14','5','9','6','3','2','6'],
			['16','7','9','6','3','4','6'],
			['17','8','9','6','3','5','6'],
			['15','5','10','6','4','1','6'],
			['17','8','9','6','3','5','6'],
			['15','5','10','6','4','1','6'],
			['17','7','10','6','4','3','6'],
			['18','7','11','6','5','2','6'],
			['19','8','11','6','5','3','6'],
			['21','8','13','6','7','1','6'],
			['14','4','8','4','1','5','6'],
			['15','4','9','4','1','5','6'],
			['15','7','9','7','1','5','6'],
			['13','8','7','8','2','4','6'],
			['15','5','9','5','2','4','6'],
			['15','8','9','8','2','4','6'],
			['16','5','10','5','2','4','6'],
			['16','7','10','7','2','4','6'],
			['15','7','9','7','4','2','6'],
			['15','8','9','8','4','2','6'],
			['17','5','11','5','4','2','6'],
			['17','8','11','8','4','2','6'],
			['18','5','12','5','4','2','6'],
			['18','7','12','5','4','2','6'],
			['18','4','12','4','5','1','6'],
			['18','8','12','8','5','1','6'],
			['19','4','13','4','5','1','6'],
			['19','7','13','7','5','1','6'],
			['11','5','7','5','1','3','6'],
			['11','8','7','8','1','3','6'],
			['12','8','7','8','1','3','6'],
			['12','8','7','8','1','4','6'],
			['13','4','8','4','2','3','6'],
			['13','7','8','7','2','3','6'],
			['15','4','8','4','2','5','6'],
			['13','5','9','5','3','1','6'],
			['14','4','9','4','3','2','6'],
			['16','5','9','5','3','4','6'],
			['16','8','9','8','3','4','6'],
			['17','7','9','7','3','5','6'],
			['17','4','9','4','3','5','6'],
			['15','7','10','7','4','1','6'],
			['15','8','10','8','4','1','6'],
			['17','5','10','5','4','3','6'],
			['17','8','10','8','4','3','6'],
			['18','4','11','4','5','2','6'],
			['18','8','11','8','5','2','6'],
			['19','4','11','4','5','3','6'],
			['19','7','11','7','5','3','6']
		];
		
		numMatrix4 = jsPsych.randomization.repeat(numMatrix4, 1, false);
		numMatrix5 = jsPsych.randomization.repeat(numMatrix5, 1, false);
		numMatrix6 = jsPsych.randomization.repeat(numMatrix6, 1, false);
		numMatrix = [numMatrix4, numMatrix5, numMatrix6];
		
		var welcome = "Welcome to the experiment.  Press Enter to continue.";
		var instructions1 = '<div id="instructions"><p>During the experiment, you will be asked to solve a series of subtraction problems that look like this:</p>\<p><img src="img/example1.gif"></p>\<p>Press 0-9 on the top of your keyboard to answer.  Always work from the leftmost number to the rightmost when subtracting.</p>\ <p>Press Enter to continue.</p>';
		var instructions2 = '<div id="instructions"><p>In addition, you will be asked if you see a certain number above the subtraction signs.</p>\<p>Press "y" for yes and "n" for no. </p>\<p> <img src="img/example1a.gif"> </p>\<p> Press Enter to continue.</p>';
		var instructions2a = '<div id="instructions"><p>You can make the two responses (0-9 and y/n) at any time.  It does not matter which order they are in. After you make the two responses, you will be told whether or not you answered correctly.</p>\ <p><img src="img/example2a.gif"</p> \ <p>Press Enter to continue. </p>';
		var instructions3 = '<div id="instructions"><p>Sometimes you will not see a number above the subtraction signs.  Just type the answer when this happens. </p>\<p><img src="img/example3.gif"></p>\<p>Work as quickly as you can without sacrificing accuracy.</p>\<p>Press Enter to start some practice problems.</p>';
		var instructions4 = '<div id="instructions"><p>End of practice.  Press Enter to begin the experiment.</p>';
		var practiceText = '<div id="instructions"><p>For this practice set of subtraction problems, determine whether the number 3 is above the subtraction signs.  Press "y" for yes and "n" for no.</p>\<p>You can respond y/n and 0-9 at any time and the order you press the keys does not matter.  Press Enter to continue.</p>';
		var experimentEnd = '<div id="instructions"><p>The experiment has ended.  Press Enter to exit.  Thank you for participating.</p>';
		
		var last_trial_probe_correct = false; // for keeping track of answers to give feedback
		var last_trial_answer_correct = false; // for keeping track of answers to give feedback
		var last_trial_nums = [];
		var last_trial_show_probe = 0;

	
		var times = [500,1000,1500,2000];
		var pick_times = times[Math.floor(Math.random()*4)];
		var trials = [];	

		//practice block loop
			var practiceBlock = [];
			for (var i=0;i<numMatrix3.length;i++) {
				var probes = [1,1,1,1,2,2,2,2,5];
				var showProbe = probes[Math.floor(Math.random()*probes.length)];
				var t = {};
				t.stimuli = [createStimulus(numMatrix3[i],0),createStimulus(numMatrix3[i],showProbe)];
				t.timing_first_stim = pick_times;
				t.choices = [[48,49,50,51,52,53,54,55,56,57],[78,89]];
				if(showProbe == 5){
					t.choices = [[48,49,50,51,52,53,54,55,56,57]];
				}
				
				t.data = {};
				
				var expectedProbeAnswer = 78;
				if(showProbe == 1) {
					if(numMatrix3[i][1] == numMatrix3[i][6]) { expectedProbeAnswer = 89; }
				} else if(showProbe == 2) {
					if(numMatrix3[i][3] == numMatrix3[i][6]) { expectedProbeAnswer = 89; }
				} else {
					expectedProbeAnswer = -1;
				}
				t.data.probeAnswer = expectedProbeAnswer;
				
				t.data.expectedActualAnswer = numMatrix3[i][5].charCodeAt(0);
				
				t.data.problemCode = JSON.stringify(numMatrix3[i]);
				t.data.showProbe = showProbe;
				practiceBlock.push(t);
			}
		//	trials.push(practiceBlock);
		
		//experiment block loop
		for(var w=0; w < 3; w++){
			var trialsblock = [];
			for (var i=0;i<numMatrix[w].length;i++) {
				var probes = [1,1,1,1,2,2,2,2,5];
				var showProbe = probes[Math.floor(Math.random()*probes.length)];
				var t = {};
				t.stimuli = [createStimulus(numMatrix[w][i],0),createStimulus(numMatrix[w][i],showProbe)];
				t.timing_first_stim = pick_times;
				t.choices = [[48,49,50,51,52,53,54,55,56,57],[78,89]];
				if(showProbe == 5){
					t.choices = [[48,49,50,51,52,53,54,55,56,57]];
				}
				
				t.data = {};
				
				var expectedProbeAnswer = 78;
				if(showProbe == 1) {
					if(numMatrix[w][i][1] == numMatrix[w][i][6]) { expectedProbeAnswer = 89; }
				} else if(showProbe == 2) {
					if(numMatrix[w][i][3] == numMatrix[w][i][6]) { expectedProbeAnswer = 89; }
				} else {
					expectedProbeAnswer = -1;
				}
				t.data.probeAnswer = expectedProbeAnswer;
				
				t.data.expectedActualAnswer = numMatrix[w][i][5].charCodeAt(0);
				
				t.data.problemCode = JSON.stringify(numMatrix[w][i]);
				t.data.showProbe = showProbe;
				trialsblock.push(t);
			}
			trials.push(trialsblock);
		}

		//trials is an [] with 400 + elements
		//so, trials[10] is an object that looks like:
		//trials[10].stimuli = [stimulus1, stimulus2];
		//trials[10].timing_first_stim = 750;

		var experiment = [];

		welcome = {
			type: 'text',
			text: [welcome],
			timing_post_trial: 750
		};

		experiment.push(welcome);

		instructions1 = {
			type: 'text',
			text: [instructions1],
			timing_post_trial: 0
		};

		experiment.push(instructions1);

		instructions2 = {
			type: 'text',
			text: [instructions2],
			timing_post_trial: 0
		};

		experiment.push(instructions2);
		
		instructions2a = {
			type: 'text',
			text: [instructions2a],
			timing_post_trial: 0
		};

		experiment.push(instructions2a);

		instructions3 = {
			type: 'text',
			text: [instructions3],
			timing_post_trial: 1500
		};

		experiment.push(instructions3);
		
		practiceText = {
			type: 'text',
			text: [practiceText],
			timing_post_trial: 2500
		};

		experiment.push(practiceText);
		
		for(var row = 0; row < 10; row++){
			var fixationPractice = {
				type: 'single-stim',
				choices: [],
				timing_stim: 1000,
				timing_response: 1000,
				timing_post_trial: 0,
				continue_after_response: false,
				is_html: true,
				stimuli: [createFixation()]
			}
			var blockPractice = { 
				type: 'twostim-tworesponse',
				choices: practiceBlock[row].choices,
				stimuli: [practiceBlock[row].stimuli],
				timing_first_stim: practiceBlock[row].timing_first_stim,
				is_html: true,
				data: [practiceBlock[row].data],
				timing_post_trial: 0
				};
			var feedback_blockPractice = {
				type: 'single-stim',
				timing_stim: 2000,
				timing_response: 2000,
				continue_after_respone: false,
				choices: [],
				stimuli: [function(){

					var html = createStimulus(last_trial_nums, last_trial_show_probe, true, last_trial_answer_correct, last_trial_probe_correct);
					return html;
				}],
				is_html: true,
				timing_post_trial: 1000
			}
		experiment.push(fixationPractice);
		experiment.push(blockPractice);
		experiment.push(feedback_blockPractice);
		}
		
		instructions4 = {
			type: 'text',
			text: [instructions4],
			timing_post_trial: 2500
		};

		experiment.push(instructions4);
		
		// add a loop for the three blocks
		for(var b = 0; b < 3; b++){
			
			var which_probe = "";
			if(b == 0) { which_probe = "4"; }
			
			var beginBlockText = '<div id="instructions"><p>For this set of subtraction problems, determine whether the number ' + which_probe + ' is above the subtraction signs.  Press "y" for yes and "n" for no.</p>\<p>  Press Enter to continue.</p>';
			
			beginBlockText = {
				type: 'text',
				text: [beginBlockText],
				timing_post_trial: 2500
			};
			
			experiment.push(beginBlockText);
			
			for(var row = 0; row < trials[b].length; row++){
				var fixation = {
					type: 'single-stim',
					choices: [],
					timing_stim: 1000,
					timing_response: 1000,
					timing_post_trial: 0,
					continue_after_response: false,
					is_html: true,
					stimuli: [createFixation()]
				}
				var block = { 
					type: 'twostim-tworesponse',
					choices: trials[b][row].choices,
					stimuli: [trials[b][row].stimuli],
					timing_first_stim: trials[b][row].timing_first_stim,
					is_html: true,
					data: [trials[b][row].data],
					timing_post_trial: 0
					};
				var feedback_block = {
					type: 'single-stim',
					timing_stim: 2000,
					timing_response: 2000,
					continue_after_respone: false,
					choices: [],
					stimuli: [function(){
						
						var html = createStimulus(last_trial_nums, last_trial_show_probe, true, last_trial_answer_correct, last_trial_probe_correct);
						return html;
					}],
					is_html: true,
					timing_post_trial: 1000
				}
				experiment.push(fixation);
				experiment.push(block);
				experiment.push(feedback_block);
			}
		}
		

		experimentEnd = {
			type: 'text',
			text: [experimentEnd],
			timing_post_trial: 2500
		};

		experiment.push(experimentEnd);

        jsPsych.init({
            display_element: $('#jspsych_target'),
            experiment_structure: experiment,
            on_finish: function(data) {
                $("#jspsych_target").append($('<pre>', {
                    html: jsPsych.dataAsCSV()
                }));
                
                jsPsych.saveCSVdata("data.csv");
            },
            on_data_update: function(data) {
            	if(data.trial_type == 'twostim-tworesponse') {
            		
            		last_trial_nums = JSON.parse(data.problemCode);
            		last_trial_show_probe = data.showProbe;
            		
            		var responses = JSON.parse(data.key_press);
            		if(_.contains(responses, data.probeAnswer)) {
            			last_trial_probe_correct = true;
            		} else {
            			last_trial_probe_correct = false;
            		}
            		
            		if(_.contains(responses, data.expectedActualAnswer)) {
            			last_trial_answer_correct = true ;
            		} else {
            			last_trial_answer_correct = false; 
            		}
            		
            		
            	}
            }
        });
    </script>
</html>
